<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Using AgePopDenom</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Using AgePopDenom</h1>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p><strong>AgePopDenom</strong> is an R package designed for
geostatistical modeling of fine-scale population age structures. By
combining nationally representative survey data (e.g., DHS), geospatial
rasters (e.g., population density), and administrative shapefiles, it
produces single-year age distributions at a high spatial resolution.
This vignette walks you through installing <strong>AgePopDenom</strong>,
setting up a project directory, running the modeling workflow, and
creating outputs such as predictive rasters and age pyramids.</p>
<p>A key advantage of <strong>AgePopDenom</strong> is its simplicity.
The <code>init()</code> and <code>run_full_workflow()</code> functions
handle everything from data retrieval to model fitting and result
generation, making it much easier to produce fine-scale demographic maps
for public health and development applications. Whether you need to
incorporate custom covariates or use your own population rasters, the
package is flexible and supports a wide range of user inputs.</p>
<hr />
</div>
<div id="installation" class="section level1">
<h1>Installation</h1>
<div id="system-requirements" class="section level2">
<h2>System Requirements</h2>
<p>Before installing <strong>AgePopDenom</strong>, ensure your system
meets the following requirements:</p>
<ol style="list-style-type: decimal">
<li><strong>R version</strong>: &gt;= 4.1.0</li>
<li><strong>C++ compiler</strong>: C++17 compatible</li>
<li><strong>TMB</strong> (Template Model Builder)</li>
</ol>
<div id="platform-specific-setup" class="section level3">
<h3>Platform-Specific Setup</h3>
<div id="windows" class="section level4">
<h4>Windows</h4>
<ol style="list-style-type: decimal">
<li>Install Rtools (matches your R version):</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Check if Rtools is installed and properly configured</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>pkgbuild<span class="sc">::</span><span class="fu">has_build_tools</span>()</span></code></pre></div>
<p>If FALSE, download and install Rtools from: <a href="https://cran.r-project.org/bin/windows/Rtools/">CRAN
Rtools</a></p>
<p><strong>macOS</strong></p>
<ol style="list-style-type: decimal">
<li>Install Command Line Tools:</li>
</ol>
<pre><code>xcode-select --install</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Alternatively, install gcc via Homebrew:</li>
</ol>
<pre><code>brew install gcc</code></pre>
<p><strong>Linux (Ubuntu/Debian)</strong></p>
<ol style="list-style-type: decimal">
<li>Update your system and install necessary packages:</li>
</ol>
<pre><code>sudo apt-get update
sudo apt-get install build-essential libxml2-dev</code></pre>
</div>
</div>
</div>
<div id="agepopdenom-installation" class="section level2">
<h2>AgePopDenom installation</h2>
<p>Once the setup is complete, follow the instructions below to download
<strong>AgePopDenom</strong></p>
<p>Note: <strong>AgePopDenom</strong> is currently under development.
Once it is available on CRAN, you will be able to install it using the
following command:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># install.packages(&quot;AgePopDenom&quot;)</span></span></code></pre></div>
<p>To get the development version from GitHub, use:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># install.packages(&quot;devtools&quot;)</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;truenomad/AgePopDenom&quot;</span>)</span></code></pre></div>
<p>Then load it in R:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">library</span>(AgePopDenom)</span></code></pre></div>
</div>
</div>
<div id="workflow-overview" class="section level1">
<h1>Workflow Overview</h1>
<p>AgePopDenom provides a streamlined workflow to generate age-specific
population estimates at a 5 km x 5 km resolution (by default). The main
steps are: 1. Initialize a project 2. Obtain and organize data (survey
data, population rasters, shapefiles) 3. Run the geostatistical model 4.
Generate spatial predictions 5. Export and visualize results. Below is a
typical usage pipeline.</p>
<div id="initialize-a-project" class="section level2">
<h2>1. Initialize a Project</h2>
<p>Before starting, ensure you have an <strong>RStudio project</strong>
set up. This will help organize your analysis and outputs into a single,
self-contained directory. <strong>Working from an RStudio project is
essential</strong> for maintaining reproducibility and keeping your
workflow organized.</p>
<p>Once the RStudio project is created, initialize the project folder
structure and create the key scripts by running:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">init</span>(</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="at">r_script_name =</span> <span class="st">&quot;full_pipeline.R&quot;</span>,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="at">cpp_script_name =</span> <span class="st">&quot;model.cpp&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>)</span></code></pre></div>
<p>The <code>init()</code> function sets up your project’s directory
structure and creates necessary script templates. When executed, it
creates a standardized folder hierarchy that organizes your data,
scripts, and outputs. The function accepts several parameters to
customize your setup:</p>
<ul>
<li><code>r_script_name</code>: Names your main R script (defaults to
“full_pipeline.R”)</li>
<li><code>cpp_script_name</code>: Names your C++ model script (defaults
to “model.cpp”)</li>
<li><code>open_r_script</code>: Controls whether the R script opens
automatically after creation</li>
<li><code>setup_rscript</code>: Determines if the R script should
include template code</li>
</ul>
<p>The resulting directory structure includes:</p>
<pre><code>01_data/
  1a_survey_data/
    processed/
    raw/
  1b_rasters/
    urban_extent/
    pop_raster/
  1c_shapefiles/
02_scripts/
03_outputs/
  3a_model_outputs/
  3b_visualizations/
  3c_table_outputs/
  3d_compiled_results/</code></pre>
<p>and two scripts:</p>
<ul>
<li><p><strong>full_pipeline.R</strong> (orchestrates the entire
analysis)</p></li>
<li><p><strong>model.cpp</strong> (C++ model for fast
optimization)</p></li>
</ul>
</div>
<div id="gather-data" class="section level2">
<h2>2. Gather data</h2>
<p>You can download or place your own survey data into
<code>01_data/1a_survey_data/processed/</code>. The survey data should
contain at least:</p>
<ul>
<li><em>lat</em>, <em>lon</em> for location</li>
<li><em>age_in_years</em> for each individual</li>
<li>An <em>urban</em> indicator (if available)</li>
</ul>
<p>To download DHS data, do:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">download_dhs_datasets</span>(</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="at">country_codes =</span> <span class="fu">c</span>(<span class="st">&quot;GMB&quot;</span>),</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="at">email =</span> <span class="st">&quot;my_email@example.com&quot;</span>,</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="at">project =</span> <span class="st">&quot;Population project&quot;</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>)</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="fu">process_dhs_data</span>()</span></code></pre></div>
<p>Next, retrieve shapefiles (e.g., WHO boundaries):</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">download_shapefile</span>(<span class="st">&quot;GMB&quot;</span>)</span></code></pre></div>
<p>Obtain population rasters (e.g., WorldPop):</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">download_pop_rasters</span>(<span class="st">&quot;GMB&quot;</span>)</span></code></pre></div>
<p>Extract urban extent (included with <strong>AgePopDenom</strong> or
supply your own):</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">extract_afurextent</span>()</span></code></pre></div>
</div>
<div id="run-the-full-workflow" class="section level2">
<h2>3. Run the Full Workflow</h2>
<p>Use <code>run_full_workflow()</code> to fit the spatial model,
predict gamma parameters, and generate aggregated outputs:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">run_full_workflow</span>(<span class="st">&quot;GMB&quot;</span>)</span></code></pre></div>
<p>When you call <code>run_full_workflow(&quot;country_code&quot;)</code>,
<strong>AgePopDenom</strong> executes the following sub-functions in
sequence:</p>
<div id="i.-fit_spatial_model" class="section level3">
<h3>3i. <code>fit_spatial_model()</code></h3>
<p><code>fit_spatial_model()</code> fits a parameter-based
geostatistical model using Template Model Builder (C++). It reads survey
data, then estimates the Gamma shape (α) and scale (λ) parameters at
each cluster, accounting for spatial correlation via a distance
matrix.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">fit_spatial_model</span>(</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>  country_code,</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  data,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="at">scale_outcome =</span> <span class="st">&quot;log_scale&quot;</span>,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  <span class="at">shape_outcome =</span> <span class="st">&quot;log_shape&quot;</span>,</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  <span class="at">covariates =</span> <span class="st">&quot;urban&quot;</span>,</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>  <span class="at">cpp_script_name =</span> <span class="st">&quot;02_scripts/model&quot;</span>,</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="st">&quot;03_outputs/3a_model_outputs&quot;</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>)</span></code></pre></div>
<p>This function fits a parameter-based geostatistical model using
Template Model Builder (TMB). Parameters:</p>
<ul>
<li><code>country_code</code>: ISO3 country code (e.g., “GMB”)</li>
<li><code>data</code>: Survey data frame containing:</li>
<li><code>lat</code>, <code>lon</code>: Geographic coordinates</li>
<li><code>age_in_years</code>: Individual ages</li>
<li><code>urban</code>: Urban/rural indicator (0/1)</li>
<li><code>scale_outcome</code>: Column name for log scale parameter</li>
<li><code>shape_outcome</code>: Column name for log shape parameter</li>
<li><code>covariates</code>: Vector of covariate names</li>
<li><code>cpp_script_name</code>: Path to TMB C++ script</li>
<li><code>output_dir</code>: Directory for model outputs</li>
<li><code>manual_params</code>: Optional list of manual parameter
values:</li>
<li><code>beta1</code>: Vector of coefficients for scale model</li>
<li><code>beta2</code>: Vector of coefficients for shape model</li>
<li><code>gamma</code>: Spatial correlation parameter</li>
<li><code>log_sigma2</code>: Log of spatial variance</li>
<li><code>log_phi</code>: Log of spatial range parameter</li>
<li><code>log_tau2_1</code>: Log of nugget variance</li>
<li><code>control_params</code>: Optional list of optimization control
parameters:</li>
<li><code>trace</code>: Level of output (0-6)</li>
<li><code>maxit</code>: Maximum iterations</li>
<li><code>abs.tol</code>: Absolute convergence tolerance</li>
</ul>
<p>The function returns a list containing:</p>
<p>- <code>par</code>: Named vector of fitted parameters</p>
<p>- <code>objective</code>: Final objective function value</p>
<p>- <code>convergence</code>: Convergence status (0 = success)</p>
<p>- <code>scale_formula</code>, <code>shape_formula</code>: Model
formulas</p>
<p>- <code>variogram</code>: Fitted variogram object (if applicable)</p>
<p>The <code>manual_params</code> input in the
<code>fit_spatial_model()</code> function allows users to provide their
own initial parameter estimates, offering greater control over the model
optimization process. This is especially useful when default estimates
from the linear regression or variogram fitting might not suit specific
use cases or when prior knowledge of the data suggests alternative
starting values.</p>
<p>When using <code>manual_params</code>, the user must supply a list
containing the following required parameters:</p>
<ul>
<li><p><code>beta1</code>: Coefficients for the scale parameter linear
model</p></li>
<li><p><code>beta2</code>: Coefficients for the shape parameter linear
model</p></li>
<li><p><code>gamma</code>: Coefficient regulating the relationship
between the shape and scale parameters</p></li>
<li><p><code>log_sigma2</code>: Log-transformed variance of the Gaussian
process</p></li>
<li><p><code>log_phi</code>: Log-transformed spatial range parameter,
derived from variogram fitting or user input</p></li>
<li><p><code>log_tau2_1</code>: Log-transformed nugget effect for the
Gaussian process</p></li>
</ul>
<p>If <code>manual_params</code> is not provided, the function derives
these values using default methods, including linear regression for
beta1 and beta2 and an empirical variogram for log_phi. However, when
<code>manual_params</code> is supplied, it overrides these defaults,
enabling advanced users to refine model initialization or replicate
earlier analyses with exact parameter values.</p>
<p>The parameters serve different modeling purposes:</p>
<ol style="list-style-type: decimal">
<li><strong>Fixed Effects Parameters</strong> (<code>beta1</code>,
<code>beta2</code>):</li>
</ol>
<ul>
<li>Control the relationship between covariates and the gamma
distribution parameters</li>
<li>Length must match the number of covariates</li>
<li>Typically estimated from initial linear models</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Spatial Parameters</strong> (<code>log_sigma2</code>,
<code>log_phi</code>):</li>
</ol>
<ul>
<li>Control the spatial correlation structure</li>
<li><code>log_sigma2</code>: Determines strength of spatial effects</li>
<li><code>log_phi</code>: Controls the effective range of spatial
correlation</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><strong>Error and Correlation Parameters</strong>
(<code>gamma</code>, <code>log_tau2_1</code>):</li>
</ol>
<ul>
<li><code>gamma</code>: Links shape and scale parameters</li>
<li><code>log_tau2_1</code>: Accounts for measurement uncertainty</li>
</ul>
<p>When specifying manual parameters, consider: - Parameter scales (some
are log-transformed) - Relationship to your data’s spatial structure -
Computational stability (avoid extreme values) - Previous successful
model fits</p>
<p>The <code>control_params</code> can be adjusted alongside
<code>manual_params</code> to fine-tune the optimization process:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>control_params <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>  <span class="at">trace =</span> <span class="dv">3</span>,        <span class="co"># Higher values show more optimization details</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>  <span class="at">maxit =</span> <span class="dv">2000</span>,     <span class="co"># Increase for complex spatial structures</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>  <span class="at">abs.tol =</span> <span class="fl">1e-10</span>,  <span class="co"># Stricter convergence criteria</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>  <span class="at">rel.tol =</span> <span class="fl">1e-8</span>    <span class="co"># Relative convergence tolerance</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>)</span></code></pre></div>
<p>Here’s the technical implementation:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">fit_spatial_model</span>(</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>  <span class="at">data =</span> survey_data,</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>  <span class="at">scale_outcome =</span> <span class="st">&quot;log_scale&quot;</span>,</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>  <span class="at">shape_outcome =</span> <span class="st">&quot;log_shape&quot;</span>,</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>  <span class="at">covariates =</span> <span class="st">&quot;urban&quot;</span>,</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>  <span class="at">cpp_script_name =</span> <span class="st">&quot;02_scripts/model&quot;</span>,</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>  <span class="at">manual_params =</span> <span class="fu">list</span>(</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>    <span class="at">beta1 =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="sc">-</span><span class="fl">0.3</span>),</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>    <span class="at">beta2 =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.1</span>),</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>    <span class="at">gamma =</span> <span class="fl">0.8</span>,</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>    <span class="at">log_sigma2 =</span> <span class="fu">log</span>(<span class="fl">0.5</span>),</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>    <span class="at">log_phi =</span> <span class="fu">log</span>(<span class="dv">100</span>),</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>    <span class="at">log_tau2_1 =</span> <span class="fu">log</span>(<span class="fl">0.1</span>)</span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>  ),</span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>  <span class="at">control_params =</span> <span class="fu">list</span>(</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>    <span class="at">trace =</span> <span class="dv">3</span>,</span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>    <span class="at">maxit =</span> <span class="dv">2000</span>,</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>    <span class="at">abs.tol =</span> <span class="fl">1e-10</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>  )</span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="ii.-generate_variogram_plot" class="section level3">
<h3>3ii. <code>generate_variogram_plot()</code></h3>
<p>This function creates empirical and fitted variograms to assess
spatial correlation structure in the data. It visualizes how similarity
(in terms of age) between the different cluster locations changes with
distance.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">generate_variogram_plot</span>(</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>  age_param_data,</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>  fit_vario,</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>  country_code,</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>  <span class="at">scale_outcome =</span> <span class="st">&quot;log_scale&quot;</span>,</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="st">&quot;03_outputs/3b_visualizations&quot;</span>,</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">12</span>,</span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>  <span class="at">height =</span> <span class="dv">9</span>,</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>  <span class="at">png_resolution =</span> <span class="dv">300</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>)</span></code></pre></div>
<p>Parameters:</p>
<ul>
<li><code>age_param_data</code>: Data frame containing survey locations
and parameters</li>
<li><code>fit_vario</code>: Fitted variogram object from spatial
model</li>
<li><code>country_code</code>: ISO3 country code</li>
<li><code>scale_outcome</code>: Column name for outcome variable
(“log_scale” or “log_shape”)</li>
<li><code>output_dir</code>: Directory for saving plots</li>
<li><code>width</code>, <code>height</code>: Plot dimensions in
inches</li>
<li><code>png_resolution</code>: Resolution of saved PNG file in
DPI</li>
</ul>
<p>The function: - Computes empirical variogram from data points -
Overlays fitted theoretical variogram - Creates diagnostic plot showing
spatial correlation decay - Saves plot as PNG file in specified output
directory</p>
<p>Returns: - ggplot2 object of variogram plot - Saved PNG file in
output directory</p>
</div>
<div id="iii.-create_prediction_data" class="section level3">
<h3>3iii. <code>create_prediction_data()</code></h3>
<p>This function builds a gridded dataset at ~5 km resolution, merging
population rasters, urban-rural classification, and admin boundaries.
Ensures each cell is linked to the proper covariates.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">create_prediction_data</span>(</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>  country_code,</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  country_shape,</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>  pop_raster,</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  ur_raster,</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>  adm2_shape,</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>  <span class="at">cell_size =</span> <span class="dv">5000</span>,</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>  <span class="at">ignore_cache =</span> <span class="cn">FALSE</span>,</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="st">&quot;03_outputs/3a_model_outputs&quot;</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>)</span></code></pre></div>
<p>Creates a regular grid for predictions. Parameters:</p>
<ul>
<li><code>country_code</code>: ISO3 country code</li>
<li><code>country_shape</code>: sf object of country boundary</li>
<li><code>pop_raster</code>: Population density raster</li>
<li><code>ur_raster</code>: Urban/rural classification raster</li>
<li><code>adm2_shape</code>: Administrative boundaries (sf object)</li>
<li><code>cell_size</code>: Grid resolution in meters</li>
<li><code>ignore_cache</code>: Whether to regenerate existing grids</li>
<li><code>output_dir</code>: Output directory for grid data</li>
</ul>
<p>The grid includes: - Centroid coordinates - Population values -
Urban/rural classification - Administrative unit IDs</p>
</div>
<div id="iv-generate_gamma_predictions" class="section level3">
<h3>3iv <code>generate_gamma_predictions()</code></h3>
<p>This function uses the fitted model parameters to simulate Gamma
distributions at unobserved locations. Produces shape and scale
estimates plus uncertainties.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="fu">generate_gamma_predictions</span>(</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>  country_code,</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>  age_param_data,</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>  model_params,</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>  predictor_data,</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>  shapefile,</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>  <span class="at">cell_size =</span> <span class="dv">5000</span>,</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>  <span class="at">n_sim =</span> <span class="dv">5000</span>,</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>  <span class="at">ignore_cache =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="st">&quot;03_outputs/3a_model_outputs&quot;</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>)</span></code></pre></div>
<p>Parameters:</p>
<ul>
<li><p><code>country_code</code>: ISO3 country code</p></li>
<li><p><code>age_param_data</code>: Fitted parameters at survey
locations</p></li>
<li><p><code>model_params</code>: List of model parameters from
fit_spatial_model()</p></li>
<li><p><code>predictor_data</code>: Grid cells for prediction</p></li>
<li><p><code>shapefile</code>: Administrative boundaries</p></li>
<li><p><code>cell_size</code>: Grid resolution</p></li>
<li><p><code>n_sim</code>: Number of Monte Carlo simulations</p></li>
<li><p><code>ignore_cache</code>: Whether to use cached
predictions</p></li>
<li><p><code>output_dir</code>: Output directory</p></li>
</ul>
<p>Returns:</p>
<ul>
<li>Predicted shape and scale parameters</li>
</ul>
</div>
<div id="v.-generate_gamma_raster_plot" class="section level3">
<h3>3v. <code>generate_gamma_raster_plot()</code></h3>
<p>This function converts shape, scale, and derived mean-age predictions
into rasters. Creates exploratory maps for validation or visual
inspection.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="fu">generate_gamma_raster_plot</span>(</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>  predictor_data,</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>  pred_list,</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>  country_code,</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="st">&quot;03_outputs/3b_visualizations&quot;</span>,</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>  <span class="at">save_raster =</span> <span class="cn">TRUE</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>)</span></code></pre></div>
<p>Parameters:</p>
<ul>
<li><p><code>predictor_data</code>: Grid cell data</p></li>
<li><p><code>pred_list</code>: Prediction results</p></li>
<li><p><code>country_code</code>: ISO3 country code</p></li>
<li><p><code>output_dir</code>: Output directory</p></li>
<li><p><code>save_raster</code>: Whether to save raster files</p></li>
</ul>
<p>Produces:</p>
<ul>
<li><p>Shape parameter raster</p></li>
<li><p>Scale parameter raster</p></li>
<li><p>Mean age raster</p></li>
</ul>
</div>
<div id="vi.-generate_age_pop_table" class="section level3">
<h3>3vi. <code>generate_age_pop_table()</code></h3>
<p>This function computes age-specific population counts by applying
Gamma-based proportions to population rasters. Aggregates counts and
proportions at selected administrative levels (e.g., district,
region).</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="fu">generate_age_pop_table</span>(</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>  predictor_data,</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>  scale_pred,</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  shape_pred,</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>  country_code,</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>  <span class="at">age_range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">99</span>),</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>  <span class="at">age_interval =</span> <span class="dv">1</span>,</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>  <span class="at">ignore_cache =</span> <span class="cn">FALSE</span>,</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="st">&quot;03_outputs/3c_table_outputs&quot;</span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>)</span></code></pre></div>
<p>Parameters:</p>
<ul>
<li><p><code>predictor_data</code>: Grid cell data</p></li>
<li><p><code>scale_pred</code>, <code>shape_pred</code>: Predicted
parameters</p></li>
<li><p><code>country_code</code>: ISO3 country code</p></li>
<li><p><code>age_range</code>: Vector of min/max ages</p></li>
<li><p><code>age_interval</code>: Age grouping interval</p></li>
<li><p><code>ignore_cache</code>: Whether to use cached results</p></li>
<li><p><code>output_dir</code>: Output directory</p></li>
</ul>
<p>Produces two data frames:</p>
<ul>
<li><p><code>prop_df</code>: Age proportions with uncertainty</p></li>
<li><p><code>pop_df</code>: Population counts with uncertainty</p></li>
</ul>
</div>
<div id="vii.-generate_age_pyramid_plot" class="section level3">
<h3>3vii. <code>generate_age_pyramid_plot()</code></h3>
<p>This function creates population pyramids (either counts or
proportions) for visualizing demographic structures across user-defined
geographic units.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">generate_age_pyramid_plot</span>(</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>  dataset,</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>  country_code,</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>  <span class="at">output_dir =</span> <span class="st">&quot;03_outputs/3b_visualizations&quot;</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>)</span></code></pre></div>
<p>Parameters:</p>
<ul>
<li><p><code>dataset</code>: List containing prop_df and pop_df</p></li>
<li><p><code>country_code</code>: ISO3 country code</p></li>
<li><p><code>output_dir</code>: Output directory</p></li>
<li><p><code>fill_high</code>, <code>fill_low</code>: Color gradient
endpoints</p></li>
<li><p><code>line_color</code>: Bar outline color</p></li>
<li><p><code>break_axis_by</code>: Age axis interval</p></li>
</ul>
<p>Creates:</p>
<ul>
<li>A list containing both proportion and count plots.</li>
</ul>
</div>
<div id="viii.-process_final_population_data" class="section level3">
<h3>3viii. <code>process_final_population_data()</code></h3>
<p>This function summarizes final outputs into Excel or CSV files.
Allows users to retrieve final aggregated counts, proportions, and
uncertainties for reporting.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="fu">process_final_population_data</span>(</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>  <span class="at">input_dir =</span> <span class="st">&quot;03_outputs/3c_table_outputs&quot;</span>,</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  <span class="at">excel_output_file =</span> <span class="st">&quot;03_outputs/3d_compiled_results/age_pop_denom_compiled.xlsx&quot;</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>)</span></code></pre></div>
<p>Parameters: - <code>input_dir</code>: Directory containing results -
<code>excel_output_file</code>: Path for Excel outpu</p>
<p>Produces: - The function writes an Excel spreadhseet with six sheets
containing population counts and proportions at different administrative
levels (country, region, district).</p>
<p>By allowing you to pass parameters to the underlying functions,
<code>run_full_workflow()</code> offers both flexibility and efficiency
in managing the geostatistical modeling process. Each sub-function
within the workflow accepts a variety of parameters, enabling advanced
users to tailor the workflow to their specific needs. These parameters
support customization of datasets, modeling approaches (including
initial model parameters and additional covariates), grid resolutions,
output formats, and caching options. This level of control ensures that
the workflow aligns with the specific analytical requirements of the
user.</p>
</div>
</div>
<div id="example-gambia" class="section level2">
<h2>Example: Gambia</h2>
<p>To demonstrate <strong>AgePopDenom</strong>, we provide an example
workflow using simulated DHS-like data for Gambia. This enables users to
replicate fine-scale age-structured population modeling locally without
requiring restricted data access. The example covers directory setup,
dummy data simulation, and running the full modeling workflow.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># Get Package ------------------------------------------------------------------</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="co"># install package</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;AgePopDenom&quot;</span>)</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co"># Working directory ------------------------------------------------------------</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co"># set working directory based on script location if not using an R project</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="co"># this ensures relative paths work as expected outside .Rproj environments</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="co"># get script path</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>current_file_path <span class="ot">&lt;-</span> AgePopDenom<span class="sc">::</span><span class="fu">get_current_script_path</span>()</span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>script_dir <span class="ot">&lt;-</span> <span class="fu">dirname</span>(current_file_path)</span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a><span class="co"># set working directory to script directory if not already in a project</span></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">&quot;</span><span class="sc">\\</span><span class="st">.Rproj$&quot;</span>, <span class="fu">list.files</span>(script_dir)))) {</span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>  <span class="fu">setwd</span>(script_dir)</span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>  <span class="fu">message</span>(</span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>    <span class="st">&quot;no .Rproj file found. using script directory as working directory: &quot;</span>,</span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a>    script_dir</span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>  )</span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;.Rproj file detected. assuming project is correctly set up.&quot;</span>)</span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a>}</span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a><span class="co"># Create directory and file Structure ------------------------------------------</span></span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a>AgePopDenom<span class="sc">::</span><span class="fu">init</span>(</span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a>  <span class="at">r_script_name =</span> <span class="st">&quot;full_pipeline.R&quot;</span>,</span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a>  <span class="at">cpp_script_name =</span> <span class="st">&quot;model.cpp&quot;</span>,</span>
<span id="cb25-31"><a href="#cb25-31" tabindex="-1"></a>  <span class="at">open_r_script =</span> <span class="cn">FALSE</span></span>
<span id="cb25-32"><a href="#cb25-32" tabindex="-1"></a>)</span>
<span id="cb25-33"><a href="#cb25-33" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" tabindex="-1"></a><span class="co"># Gather and process datasets --------------------------------------------------</span></span>
<span id="cb25-35"><a href="#cb25-35" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" tabindex="-1"></a><span class="co"># set up country code</span></span>
<span id="cb25-37"><a href="#cb25-37" tabindex="-1"></a>cntry_code <span class="ot">=</span> <span class="st">&quot;GMB&quot;</span></span>
<span id="cb25-38"><a href="#cb25-38" tabindex="-1"></a>country <span class="ot">=</span> <span class="st">&quot;Gambia&quot;</span></span>
<span id="cb25-39"><a href="#cb25-39" tabindex="-1"></a>country_code_dhs <span class="ot">=</span> <span class="st">&quot;GM&quot;</span></span>
<span id="cb25-40"><a href="#cb25-40" tabindex="-1"></a></span>
<span id="cb25-41"><a href="#cb25-41" tabindex="-1"></a><span class="co"># Simulate and save processed survey dataset for Gambia</span></span>
<span id="cb25-42"><a href="#cb25-42" tabindex="-1"></a>AgePopDenom<span class="sc">::</span><span class="fu">simulate_dummy_dhs_pr</span>(</span>
<span id="cb25-43"><a href="#cb25-43" tabindex="-1"></a>  <span class="at">country =</span> country,</span>
<span id="cb25-44"><a href="#cb25-44" tabindex="-1"></a>  <span class="at">country_code_iso3 =</span> cntry_code,</span>
<span id="cb25-45"><a href="#cb25-45" tabindex="-1"></a>  <span class="at">country_code_dhs =</span> country_code_dhs,</span>
<span id="cb25-46"><a href="#cb25-46" tabindex="-1"></a>  <span class="at">year_of_survey =</span> <span class="dv">2024</span>,</span>
<span id="cb25-47"><a href="#cb25-47" tabindex="-1"></a>  <span class="at">output_path =</span> here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb25-48"><a href="#cb25-48" tabindex="-1"></a>    <span class="st">&quot;01_data&quot;</span>,</span>
<span id="cb25-49"><a href="#cb25-49" tabindex="-1"></a>    <span class="st">&quot;1a_survey_data&quot;</span>,</span>
<span id="cb25-50"><a href="#cb25-50" tabindex="-1"></a>    <span class="st">&quot;processed&quot;</span>,</span>
<span id="cb25-51"><a href="#cb25-51" tabindex="-1"></a>    <span class="st">&quot;dhs_pr_records_combined.rds&quot;</span></span>
<span id="cb25-52"><a href="#cb25-52" tabindex="-1"></a>  )</span>
<span id="cb25-53"><a href="#cb25-53" tabindex="-1"></a>)</span>
<span id="cb25-54"><a href="#cb25-54" tabindex="-1"></a></span>
<span id="cb25-55"><a href="#cb25-55" tabindex="-1"></a><span class="co"># download shapefiles</span></span>
<span id="cb25-56"><a href="#cb25-56" tabindex="-1"></a>AgePopDenom<span class="sc">::</span><span class="fu">download_shapefile</span>(cntry_code)</span>
<span id="cb25-57"><a href="#cb25-57" tabindex="-1"></a></span>
<span id="cb25-58"><a href="#cb25-58" tabindex="-1"></a><span class="co"># download population rasters from worldpop</span></span>
<span id="cb25-59"><a href="#cb25-59" tabindex="-1"></a>AgePopDenom<span class="sc">::</span><span class="fu">download_pop_rasters</span>(cntry_code)</span>
<span id="cb25-60"><a href="#cb25-60" tabindex="-1"></a></span>
<span id="cb25-61"><a href="#cb25-61" tabindex="-1"></a><span class="co"># wxtract urban extent raster</span></span>
<span id="cb25-62"><a href="#cb25-62" tabindex="-1"></a>AgePopDenom<span class="sc">::</span><span class="fu">extract_afurextent</span>()</span>
<span id="cb25-63"><a href="#cb25-63" tabindex="-1"></a></span>
<span id="cb25-64"><a href="#cb25-64" tabindex="-1"></a><span class="co"># Run models and get outputs ---------------------------------------------------</span></span>
<span id="cb25-65"><a href="#cb25-65" tabindex="-1"></a></span>
<span id="cb25-66"><a href="#cb25-66" tabindex="-1"></a><span class="co"># run the full model workflow</span></span>
<span id="cb25-67"><a href="#cb25-67" tabindex="-1"></a>AgePopDenom<span class="sc">::</span><span class="fu">run_full_workflow</span>(cntry_code)</span></code></pre></div>
<p>For more detailed information on advanced usage (e.g., integrating
additional covariates, applying user-supplied rasters), consult the
function-specific help files. We hope this package encourages you to
reliably estimate age-structured population counts in diverse contexts
and at finer geographic scales than was previously feasible.</p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
